name: Watchdog - Weekly Smoke Tests

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  smoke-test:
    name: Weekly Smoke Test (Dry-Run)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 09_APP/prose-legal-db-app/package-lock.json
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl git build-essential shellcheck bats
      
      - name: Run shellcheck
        run: |
          shellcheck -x restore_christine.sh || echo "‚ö†Ô∏è shellcheck warnings"
      
      - name: Run BATS tests
        run: |
          if [ -f "tests/restore_christine.bats" ]; then
            bats tests/restore_christine.bats || exit 1
          else
            echo "‚ö†Ô∏è BATS tests not found"
            exit 1
          fi
      
      - name: Dry-run restore_christine.sh
        run: |
          chmod +x restore_christine.sh
          ./restore_christine.sh --dry-run || exit 1
      
      - name: Test React app build
        run: |
          cd 09_APP/prose-legal-db-app
          npm ci
          npm run build || exit 1
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `üö® Watchdog: Smoke test failed on ${new Date().toISOString().split('T')[0]}`;
            const body = `## Smoke Test Failure
            
            The weekly smoke test for \`restore_christine.sh\` has failed.
            
            **Run Details:**
            - Workflow: ${{ github.workflow }}
            - Run ID: ${{ github.run_id }}
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref }}
            
            **Failed Steps:**
            Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            
            **Next Steps:**
            1. Review the workflow logs
            2. Fix any issues found
            3. Re-run the workflow manually
            4. Close this issue once resolved
            
            **Auto-generated by Watchdog workflow**`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['watchdog', 'automated', 'ci']
            });
      
      - name: Success notification
        if: success()
        run: |
          echo "‚úÖ Weekly smoke test passed successfully!"
          echo "All checks completed without errors."

